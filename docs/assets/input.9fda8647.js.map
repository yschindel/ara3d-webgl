{"version":3,"file":"input.9fda8647.js","sources":["../../src/viewer/gizmos/gizmoAxes.ts","../../examples/index.html?html-proxy&index=0.js"],"sourcesContent":["import * as THREE from 'three'\r\nimport { Camera } from '../camera/camera'\r\n\r\nexport class Axis {\r\n  axis: string\r\n  direction: THREE.Vector3\r\n  size: number\r\n  color: string\r\n  colorSub: string\r\n  position: THREE.Vector3\r\n\r\n  // Optional\r\n  label: string | undefined\r\n  line: number | undefined\r\n\r\n  constructor (init: Axis) {\r\n    this.axis = init.axis\r\n    this.direction = init.direction\r\n    this.size = init.size\r\n    this.position = init.position\r\n    this.color = init.color\r\n    this.colorSub = init.colorSub\r\n\r\n    // Optional\r\n    this.line = init.line\r\n    this.label = init.label\r\n  }\r\n}\r\n\r\nexport class GizmoOptions {\r\n  size: number = 84\r\n  padding: number = 4\r\n  bubbleSizePrimary: number = 8\r\n  bubbleSizeSecondary: number = 6\r\n  lineWidth: number = 2\r\n  fontSize: string = '12px'\r\n  fontFamily: string = 'arial'\r\n  fontWeight: string = 'bold'\r\n  fontColor: string = '#222222'\r\n  className: string = 'gizmo-axis-canvas'\r\n\r\n  colorX: string = '#f73c3c'\r\n  colorY: string = '#6ccb26'\r\n  colorZ: string = '#178cf0'\r\n  colorXSub: string = '#942424'\r\n  colorYSub: string = '#417a17'\r\n  colorZSub: string = '#0e5490'\r\n\r\n  constructor (init?: Partial<GizmoOptions>) {\r\n    this.size = init?.size ?? this.size\r\n    this.padding = init?.padding ?? this.padding\r\n    this.bubbleSizePrimary = init?.bubbleSizePrimary ?? this.bubbleSizePrimary\r\n    this.bubbleSizeSecondary =\r\n      init?.bubbleSizeSecondary ?? this.bubbleSizeSecondary\r\n    this.lineWidth = init?.lineWidth ?? this.lineWidth\r\n    this.fontSize = init?.fontSize ?? this.fontSize\r\n    this.fontFamily = init?.fontFamily ?? this.fontFamily\r\n    this.fontWeight = init?.fontWeight ?? this.fontWeight\r\n    this.fontColor = init?.fontColor ?? this.fontColor\r\n    this.className = init?.className ?? this.className\r\n    this.colorX = init?.colorX ?? this.colorX\r\n    this.colorY = init?.colorY ?? this.colorY\r\n    this.colorZ = init?.colorZ ?? this.colorZ\r\n    this.colorXSub = init?.colorXSub ?? this.colorXSub\r\n    this.colorYSub = init?.colorYSub ?? this.colorYSub\r\n    this.colorZSub = init?.colorZSub ?? this.colorZSub\r\n  }\r\n}\r\n\r\n/**\r\n * Axes gizmo with user interaction.\r\n * It draws on its own canvas.\r\n */\r\nexport class GizmoAxes {\r\n  // settings\r\n  options: GizmoOptions\r\n  axes: Axis[]\r\n\r\n  // dependencies\r\n  camera: Camera\r\n  canvas: HTMLCanvasElement\r\n  context: CanvasRenderingContext2D\r\n  rect: DOMRect\r\n\r\n  // state\r\n  isDragging: boolean\r\n  isDragSignificant: boolean\r\n  dragStart: THREE.Vector2\r\n  dragLast: THREE.Vector2\r\n  pointer: THREE.Vector3\r\n  center: THREE.Vector3\r\n  invRotMat: THREE.Matrix4 = new THREE.Matrix4()\r\n  selectedAxis: Axis | null\r\n\r\n  constructor (camera: Camera, options?: Partial<GizmoOptions>) {\r\n    this.options = new GizmoOptions(options)\r\n    this.camera = camera\r\n    this.pointer = new THREE.Vector3()\r\n    this.dragStart = new THREE.Vector2()\r\n    this.dragLast = new THREE.Vector2()\r\n    this.center = new THREE.Vector3(\r\n      this.options.size / 2,\r\n      this.options.size / 2,\r\n      0\r\n    )\r\n    this.axes = this.createAxes()\r\n    this.selectedAxis = null\r\n    this.isDragging = false\r\n    this.isDragSignificant = false\r\n\r\n    this.canvas = this.createCanvas()\r\n    this.context = this.canvas.getContext('2d')!\r\n    this.rect = this.canvas.getBoundingClientRect()\r\n    this.context.imageSmoothingEnabled = true\r\n    this.context.imageSmoothingQuality = 'high'\r\n\r\n    this.animate()\r\n  }\r\n\r\n  animate () {\r\n    this.update()\r\n    requestAnimationFrame(() => this.animate())\r\n  }\r\n\r\n  createAxes () {\r\n    return [\r\n      new Axis({\r\n        axis: 'x',\r\n        direction: new THREE.Vector3(1, 0, 0),\r\n        size: this.options.bubbleSizePrimary,\r\n        color: this.options.colorX,\r\n        colorSub: this.options.colorXSub,\r\n        line: this.options.lineWidth,\r\n        label: 'X',\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      }),\r\n      new Axis({\r\n        axis: 'y',\r\n        direction: new THREE.Vector3(0, 1, 0),\r\n        size: this.options.bubbleSizePrimary,\r\n        color: this.options.colorY,\r\n        colorSub: this.options.colorYSub,\r\n        line: this.options.lineWidth,\r\n        label: 'Y',\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      }),\r\n      new Axis({\r\n        axis: 'z',\r\n        direction: new THREE.Vector3(0, 0, 1),\r\n        size: this.options.bubbleSizePrimary,\r\n        color: this.options.colorZ,\r\n        colorSub: this.options.colorZSub,\r\n        line: this.options.lineWidth,\r\n        label: 'Z',\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      }),\r\n      new Axis({\r\n        axis: '-x',\r\n        direction: new THREE.Vector3(-1, 0, 0),\r\n        size: this.options.bubbleSizeSecondary,\r\n        color: this.options.colorX,\r\n        colorSub: this.options.colorXSub,\r\n        line: undefined,\r\n        label: undefined,\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      }),\r\n      new Axis({\r\n        axis: '-y',\r\n        direction: new THREE.Vector3(0, -1, 0),\r\n        size: this.options.bubbleSizeSecondary,\r\n        color: this.options.colorY,\r\n        colorSub: this.options.colorYSub,\r\n        line: undefined,\r\n        label: undefined,\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      }),\r\n      new Axis({\r\n        axis: '-z',\r\n        // inverted Z\r\n        direction: new THREE.Vector3(0, 0, -1),\r\n        size: this.options.bubbleSizeSecondary,\r\n        color: this.options.colorZ,\r\n        colorSub: this.options.colorZSub,\r\n        line: undefined,\r\n        label: undefined,\r\n        position: new THREE.Vector3(0, 0, 0)\r\n      })\r\n    ]\r\n  }\r\n\r\n  createCanvas () {\r\n    const canvas = document.createElement('canvas')\r\n    canvas.width = this.options.size\r\n    canvas.height = this.options.size\r\n    canvas.style.position = 'fixed'\r\n    canvas.style.right = '24px'\r\n    canvas.style.top = '24px'\r\n    canvas.classList.add(this.options.className)\r\n\r\n    canvas.addEventListener('pointerdown', this.onPointerDown, false)\r\n    canvas.addEventListener('pointerenter', this.onPointerEnter, false)\r\n    canvas.addEventListener('pointermove', this.onPointerMove, false)\r\n    return canvas\r\n  }\r\n\r\n  onTouchStart = (e: TouchEvent) => {\r\n    e.preventDefault()\r\n    if (e.touches.length > 1) return\r\n    const touch = e.touches[0]\r\n    this.initDrag(touch.clientX, touch.clientY)\r\n\r\n    window.addEventListener('touchmove', this.onTouchMove, false)\r\n    window.addEventListener('touchend', this.onTouchEnd, false)\r\n  }\r\n\r\n  onTouchMove = (e: TouchEvent) => {\r\n    if (e.touches.length > 1) return\r\n    const touch = e.touches[0]\r\n    this.updateDrag(touch.clientX, touch.clientY)\r\n  }\r\n\r\n  onTouchEnd = (e: TouchEvent) => {\r\n    e.preventDefault()\r\n    this.endDrag()\r\n    this.selectedAxis = null\r\n    window.removeEventListener('touchmove', this.onTouchMove, false)\r\n    window.removeEventListener('touchend', this.onTouchEnd, false)\r\n  }\r\n\r\n  onPointerDown = (e: MouseEvent) => {\r\n    this.initDrag(e.clientX, e.clientY)\r\n\r\n    window.addEventListener('pointermove', this.onPointerDrag, false)\r\n    window.addEventListener('pointerup', this.onPointerUp, false)\r\n  }\r\n\r\n  onPointerUp = (event: PointerEvent) => {\r\n    this.endDrag()\r\n    if (event.pointerType !== 'mouse') {\r\n      this.pointer.set(0, 0, 0)\r\n    }\r\n\r\n    window.removeEventListener('pointermove', this.onPointerDrag, false)\r\n    window.removeEventListener('pointerup', this.onPointerUp, false)\r\n  }\r\n\r\n  onPointerEnter = () => {\r\n    this.rect = this.canvas.getBoundingClientRect()\r\n  }\r\n\r\n  // Hover\r\n  onPointerMove = (e: MouseEvent) => {\r\n    if (this.isDragging) return\r\n\r\n    if (e) {\r\n      this.pointer = this.toMouseVector(e, this.pointer)\r\n    }\r\n  }\r\n\r\n  toMouseVector (e: MouseEvent, target: THREE.Vector3) {\r\n    return target.set(e.clientX - this.rect.left, e.clientY - this.rect.top, 0)\r\n  }\r\n\r\n  // Drag\r\n  onPointerDrag = (e: MouseEvent) => {\r\n    this.updateDrag(e.clientX, e.clientY)\r\n  }\r\n\r\n  initDrag (x: number, y: number) {\r\n    this.dragStart.set(x, y)\r\n    this.dragLast.set(x, y)\r\n    this.isDragging = true\r\n    this.isDragSignificant = false\r\n\r\n    if (!this.isDragging) {\r\n      this.canvas.classList.add('dragging')\r\n    }\r\n  }\r\n\r\n  updateDrag (x: number, y: number) {\r\n    if (new THREE.Vector2(x, y).sub(this.dragStart).length() > 3) {\r\n      this.isDragSignificant = true\r\n    }\r\n\r\n    const drag = new THREE.Vector2(x, y).sub(this.dragLast)\r\n    this.dragLast.set(x, y)\r\n\r\n    const rotX = drag.x / this.canvas.width\r\n    const rotY = drag.y / this.canvas.height\r\n    this.camera.do().rotate(new THREE.Vector2(rotX, rotY))\r\n  }\r\n\r\n  endDrag () {\r\n    this.isDragging = false\r\n    if (!this.isDragSignificant) {\r\n      this.onMouseClick()\r\n      this.isDragSignificant = false\r\n    }\r\n\r\n    this.canvas.classList.remove('dragging')\r\n  }\r\n\r\n  onMouseClick = () => {\r\n    if (this.isDragging || !this.selectedAxis) return\r\n    this.camera\r\n      .lerp(1)\r\n      .orbitTowards(this.selectedAxis.direction.clone().multiplyScalar(-1))\r\n    this.selectedAxis = null\r\n  }\r\n\r\n  update = () => {\r\n    this.invRotMat.extractRotation(this.camera.matrix).invert()\r\n\r\n    for (let i = 0, length = this.axes.length; i < length; i++) {\r\n      this.setAxisPosition(this.axes[i])\r\n    }\r\n\r\n    // Sort the layers where the +Z position is last so its drawn on top of anything below it\r\n    this.axes.sort((a, b) => (a.position.z > b.position.z ? 1 : -1))\r\n\r\n    // Draw the layers\r\n    this.drawLayers(true)\r\n\r\n    // Keep axis selected during drag.\r\n    if (!this.isDragging) {\r\n      this.pickAxes(this.pointer)\r\n    }\r\n  }\r\n\r\n  drawLayers (clear: boolean) {\r\n    if (clear) {\r\n      this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)\r\n    }\r\n\r\n    // For each layer, draw the axis\r\n    for (let i = 0, length = this.axes.length; i < length; i++) {\r\n      const axis = this.axes[i]\r\n\r\n      // Set the color\r\n      const highlight = this.selectedAxis === axis\r\n      const color = axis.position.z >= -0.01 ? axis.color : axis.colorSub\r\n\r\n      // Draw the line that connects it to the center if enabled\r\n      const center2 = new THREE.Vector2(this.center.x, this.center.y)\r\n      const pos2 = new THREE.Vector2(axis.position.x, axis.position.y)\r\n      if (axis.line) this.drawLine(center2, pos2, axis.line, color)\r\n\r\n      // Draw the circle for the axis\r\n      this.drawCircle(axis.position, axis.size, highlight ? '#FFFFFF' : color)\r\n\r\n      // Write the axis label (X,Y,Z) if provided\r\n      if (axis.label) {\r\n        this.context.font = [\r\n          this.options.fontWeight,\r\n          this.options.fontSize,\r\n          this.options.fontFamily\r\n        ].join(' ')\r\n        this.context.fillStyle = this.options.fontColor\r\n        this.context.textBaseline = 'middle'\r\n        this.context.textAlign = 'center'\r\n        this.context.fillText(axis.label, axis.position.x, axis.position.y)\r\n      }\r\n    }\r\n  }\r\n\r\n  drawCircle (pos: THREE.Vector3, radius = 10, color = '#FF0000') {\r\n    this.context.beginPath()\r\n    this.context.arc(pos.x, pos.y, radius, 0, 2 * Math.PI, false)\r\n    this.context.fillStyle = color\r\n    this.context.fill()\r\n    this.context.closePath()\r\n  }\r\n\r\n  drawLine (\r\n    p1: THREE.Vector2,\r\n    p2: THREE.Vector2,\r\n    width: number = 1,\r\n    color = '#FF0000'\r\n  ) {\r\n    this.context.beginPath()\r\n    this.context.moveTo(p1.x, p1.y)\r\n    this.context.lineTo(p2.x, p2.y)\r\n    this.context.lineWidth = width\r\n    this.context.strokeStyle = color\r\n    this.context.stroke()\r\n    this.context.closePath()\r\n  }\r\n\r\n  setAxisPosition (axis: Axis) {\r\n    const position = axis.direction.clone().applyMatrix4(this.invRotMat)\r\n    const size = axis.size\r\n    axis.position.set(\r\n      position.x * (this.center.x - size / 2 - this.options.padding) +\r\n        this.center.x,\r\n      this.center.y -\r\n        position.y * (this.center.y - size / 2 - this.options.padding),\r\n      position.z\r\n    )\r\n  }\r\n\r\n  private pickAxes (mouse: THREE.Vector3) {\r\n    const currentAxis = this.selectedAxis\r\n    this.selectedAxis = null\r\n\r\n    // Loop through each layer\r\n    for (let i = 0, length = this.axes.length; i < length; i++) {\r\n      const distance = mouse.distanceTo(this.axes[i].position)\r\n\r\n      if (distance < this.axes[i].size) this.selectedAxis = this.axes[i]\r\n    }\r\n\r\n    if (currentAxis !== this.selectedAxis) this.drawLayers(false)\r\n  }\r\n\r\n  dispose = () => {\r\n    this.canvas.removeEventListener('pointerdown', this.onPointerDown, false)\r\n    this.canvas.removeEventListener('pointerenter', this.onPointerEnter, false)\r\n    this.canvas.removeEventListener('pointermove', this.onPointerDrag, false)\r\n    window.removeEventListener('pointermove', this.onPointerDrag, false)\r\n    window.removeEventListener('pointerup', this.onPointerUp, false)\r\n    this.canvas.remove()\r\n  }\r\n}\r\n\r\nexport { GizmoAxes as OrbitControlsGizmo }\r\n","\n  import * as ARA3D from '../src/index'\n  console.log(ARA3D)\n"],"names":[],"mappings":";;;;;;;;;AA6BO,MAAM,aAAa;AAAA,EAmBxB,YAAa,MAA8B;AAlB3C,gCAAe;AACf,mCAAkB;AAClB,6CAA4B;AAC5B,+CAA8B;AAC9B,qCAAoB;AACpB,oCAAmB;AACnB,sCAAqB;AACrB,sCAAqB;AACrB,qCAAoB;AACpB,qCAAoB;AAEpB,kCAAiB;AACjB,kCAAiB;AACjB,kCAAiB;AACjB,qCAAoB;AACpB,qCAAoB;AACpB,qCAAoB;AAGb,SAAA,OAAO,MAAM,QAAQ,KAAK;AAC1B,SAAA,UAAU,MAAM,WAAW,KAAK;AAChC,SAAA,oBAAoB,MAAM,qBAAqB,KAAK;AACpD,SAAA,sBACH,MAAM,uBAAuB,KAAK;AAC/B,SAAA,YAAY,MAAM,aAAa,KAAK;AACpC,SAAA,WAAW,MAAM,YAAY,KAAK;AAClC,SAAA,aAAa,MAAM,cAAc,KAAK;AACtC,SAAA,aAAa,MAAM,cAAc,KAAK;AACtC,SAAA,YAAY,MAAM,aAAa,KAAK;AACpC,SAAA,YAAY,MAAM,aAAa,KAAK;AACpC,SAAA,SAAS,MAAM,UAAU,KAAK;AAC9B,SAAA,SAAS,MAAM,UAAU,KAAK;AAC9B,SAAA,SAAS,MAAM,UAAU,KAAK;AAC9B,SAAA,YAAY,MAAM,aAAa,KAAK;AACpC,SAAA,YAAY,MAAM,aAAa,KAAK;AACpC,SAAA,YAAY,MAAM,aAAa,KAAK;AAAA,EAC3C;AACF;;;;;;;;;;;;;ACjEE,QAAQ,IAAI,KAAK;"}